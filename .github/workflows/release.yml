name: Release

permissions:
    contents: write

on:
    # 1. Automatic trigger: Runs when a tag like v1.2.3 is pushed
    push:
        tags:
            - "v[0-9]+.*"

    # 2. Manual trigger: Allows running this workflow from the Actions tab
    workflow_dispatch:

jobs:
    # Job to create a DRAFT release using the official GitHub CLI.
    create-release:
        runs-on: ubuntu-latest
        steps:
            - name: Create Draft Release with Auto-Generated Notes
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  # The tag name is available from the event that triggered the workflow
                  TAG_NAME: ${{ github.ref_name }}
              run: gh release create "$TAG_NAME" --draft --generate-notes

    # Job to build and upload binaries for multiple platforms
    upload-assets:
        # This job MUST wait for the draft release to be created first
        needs: create-release
        strategy:
            matrix:
                include:
                    # The 'aarch64-linux-android' target has been removed to skip its build.
                    - target: aarch64-unknown-linux-gnu
                      os: ubuntu-latest
                    - target: aarch64-apple-darwin
                      os: macos-latest
                    - target: x86_64-unknown-linux-gnu
                      os: ubuntu-latest
                    - target: x86_64-apple-darwin
                      os: macos-latest
                    - target: x86_64-pc-windows-gnu
                      os: windows-latest
        runs-on: ${{ matrix.os }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install MinGW for Windows GNU target
              if: runner.os == 'Windows'
              run: choco install mingw --no-progress

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: stable
                  targets: ${{ matrix.target }}

            - name: Cache Cargo dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                      target/
                  key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-cargo-${{ matrix.target }}-

            - name: Build and upload Rust binary
              uses: taiki-e/upload-rust-binary-action@v1
              with:
                  bin: tbf
                  ref: ${{ github.ref }}
                  include: LICENSE,README.md
                  target: ${{ matrix.target }}
                  archive: $bin-$tag-$target
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # This job runs ONLY after all 'upload-assets' jobs have succeeded.
    # It marks the draft release as a final, published release.
    publish-release:
        runs-on: ubuntu-latest
        # It depends on both the creation and the successful upload of all assets
        needs: [create-release, upload-assets]
        steps:
            - name: Publish Release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  TAG_NAME: ${{ github.ref_name }}
              run: gh release edit "$TAG_NAME" --draft=false
